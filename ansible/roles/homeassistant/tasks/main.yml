---
- name: Template docker-compose file
  tags: docker-compose, homeassistant
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: "{{ ha.base_path }}/docker-compose.yaml"
    owner: "{{ user.id }}"
    mode: '0644'

- name: Start Home Assistant containers
  tags: docker-compose
  ansible.builtin.command: "docker compose -f {{ ha.base_path }}/docker-compose.yaml up -d"
  register: ha_started
  changed_when: ha_started.rc == 0

- name: Wait for directory to be created in container
  tags: docker-compose, homeassistant
  ansible.builtin.wait_for:
    path: "{{ ha.config_path }}/.storage"
    state: present

- name: Template Home Assistant secrets
  tags: homeassistant
  ansible.builtin.template:
    src: secrets.yaml.j2
    dest: "{{ ha.config_path }}/secrets.yaml"
    owner: "{{ user.id }}"
    mode: '0644'

- name: Copy initial Home Assistant config file
  tags: homeassistant
  ansible.builtin.copy:
    src: configuration.yaml
    dest: "{{ ha.config_path }}"
    owner: "{{ user.id }}"
    mode: '0644'

- name: Try install HACS addon
  tags: homeassistant, hacs
  block:
    - name: Download HACS installer 
      ansible.builtin.uri:
        url: https://get.hacs.xyz
        return_content: yes
      register: hacs_installer
      
    - name: Install HACS addon
      ansible.builtin.command:
        cmd: "bash -"
        stdin: "{{ hacs_installer.content }}"
        chdir: "{{ ha.config_path }}"
        creates: "{{ ha.config_path }}/custom_components/hacs"
      notify:
        - Restart Home Assistant
  rescue:
    - name: Rollback
      ansible.builtin.file:
        path: "{{ ha.config_path }}/custom_components/hacs"
        state: absent
